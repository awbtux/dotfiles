#!/bin/sh

# script to deploy the current dotfiles
# if the login shell doesn't find .local/share/dots/.configured.txt, this runs automatically
# TODO: finish this script

# run commands
run() { cmd="$1"; shift; test -z "$(command -v "$cmd")" && return 1; printf "\033[90m\$\033[39;3m %s %s\033[0m\n" "$cmd" "$*" >&2; "$cmd" "$@"; }

# go home
cd

# generate a theme
run generate-theme nord </dev/null

# build `bat` theme cache
run bat cache --build </dev/null &

# if $HOME is the worktree of a git repo, pull from origin and init submodules
test -d "$PWD/.git" && run sh -c 'git pull; git submodule update --init --recursive' </dev/null &

# prevent this script from getting automatically sourced by login scripts
printf "%s\n%s\n%s\n%s\n" \
    "This file was created by ~/.local/bin/scripts/deploy-dots when the script" \
    "finished, so the login script responsible for one-time setup knows there" \
    "isn't anything else \`deploy-dots\` needs to do. If you delete it, the session" \
    "will invoke \`deploy-dots\` next time you log in." \
>"${XDG_DATA_HOME:-$HOME/.local/share}/dots/.configured.txt"

# wait for jobs to finish
wait
