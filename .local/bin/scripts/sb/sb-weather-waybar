#!/bin/sh

# weather script for waybar

# load shell functions
[ -r "${XDG_CONFIG_HOME:-$HOME/.config}/shell/functions" ] && . "${XDG_CONFIG_HOME:-$HOME/.config}/shell/functions"

# we need these
require-cmd curl sed || exit 127

# vars
main_fmt='%c%C,+%t'
tooltip_fmt='%c%l:+%C,+%h+humidity,+%t+(feels+like+%f),+%w+winds'
text=""
tooltip=""

# try to set text/tooltip
for i in $(seq 1 5); do
    test -n "$text" -a -n "$tooltip" && break
    test -z "$text" && printf "Querying https://wttr.in/ for bar text (attempt ${i}/5)...\n" >&2 && text="$(curl --retry 0 --max-time 20 -s "https://wttr.in/?format=$main_fmt" 2>/dev/null)"
    test -z "$tooltip" && printf "Querying https://wttr.in/ for tooltip text (attempt ${i}/5)...\n" >&2 && tooltip="$(curl --retry 0 --max-time 20 -s "https://wttr.in/?format=$tooltip_fmt" 2>/dev/null | sed -e 's/+\([0-9][0-9]*\)/\1/g')"
done

# print in json format
printf '{"text": "%s", "tooltip": "%s"}\n' "${text:-â›… no data}" "${tooltip:-failed to access weather information from https://wttr.in.}"

# exit with status
test -z "$text" -o -z "$tooltip"
exit $?
